<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.markany.gameboss.player.pojo.PlayerConsumeList">
	<resultMap type="PlayerConsumeList" id="basePlayerConsumeList" extends="com.markany.gameboss.player.pojo.BasePlayerPojo.basePlayerPojo">
		<result column="gameCode" property="gameCode"/>
		<result column="channelCode" property="channelCode"/>
		<result column="itemCode" property="itemCode"/>
		<result column="amount" property="amount"/>
		<result column="consumeTime" property="consumeTime"/>
	</resultMap>
	<resultMap type="PlayerConsumeList" id="playerConsumeList" extends="com.markany.gameboss.player.pojo.PlayerConsumeList.basePlayerConsumeList">
		<association column="channelCode" property="channel" select="com.markany.gameboss.channel.pojo.Channel.findByCode"/>
		<association column="gameCode" property="gameVersion" select="com.markany.gameboss.game.pojo.GameVersion.findByCode"/>
		<association column="itemCode" property="gameItem" select="com.markany.gameboss.game.pojo.GameItem.findByCode"/>
	</resultMap>
	<resultMap type="PlayerConsumeList" id="playerConsumeListDetail" extends="com.markany.gameboss.player.pojo.PlayerConsumeList.basePlayerConsumeList">
		<association property="gameVersion" resultMap="com.markany.gameboss.game.pojo.GameVersion.gameVersionDetail"  columnPrefix="gv_"/>
		<association property="channel" resultMap="com.markany.gameboss.channel.pojo.Channel.channel"  columnPrefix="c_"/>
		<association property="gameItem" resultMap="com.markany.gameboss.game.pojo.GameItem.baseGameItem"  columnPrefix="i_"/>
	</resultMap>

	<sql id="tableName">
		t_player_consume_list
	</sql>
	<sql id="tableAlias">
		PlayerConsumeList
	</sql>
	<sql id="joinTable">
		<if test="hasJoin and joinTableAlias.contains('GameVersion')">
     		join <include refid="com.markany.gameboss.game.pojo.GameVersion.tableName"/> GameVersion on GameVersion.code = <include refid="tableAlias" />.gameCode
     		join <include refid="com.markany.gameboss.game.pojo.Game.tableName"/> Game on Game.id = GameVersion.gameId
     	</if>
     	<if test="hasJoin and joinTableAlias.contains('Channel')">
     		join <include refid="com.markany.gameboss.channel.pojo.Channel.tableName"/> Channel on Channel.code = <include refid="tableAlias" />.channelCode
     	</if>
     	<if test="hasJoin and joinTableAlias.contains('GameItem')">
     		join <include refid="com.markany.gameboss.game.pojo.GameItem.tableName"/> GameItem on GameItem.code = <include refid="tableAlias" />.itemCode
     	</if>
	</sql>

	<select id="find" resultMap="playerConsumeList">
		select * from 
		<include refid="tableName"/> <include refid="tableAlias" />
		<include refid="joinTable"/>
		<trim prefix="where">
			<include refid="common.aliasPropertiesCondition"/>
		</trim>
	</select>
	
	<select id="findById" resultMap="playerConsumeList">
		select * from 
		<include refid="tableName"/>
		where id = #{id}
	</select>
	
	<select id="list" resultMap="playerConsumeList">
		select * from
		<include refid="tableName" /> <include refid="tableAlias" />
		<include refid="joinTable"/>
		<trim prefix="where">
			<include refid="common.aliasPropertiesCondition" />
		</trim>
		<include refid="common.sortCondition" />
		<include refid="common.pageCondition" />
	</select>
	
	<!-- 列出详细信息 -->
	<select id="listDetail" resultMap="playerConsumeListDetail">
		select 
		  PlayerConsumeList.id,
		  PlayerConsumeList.playerCode,
		  PlayerConsumeList.gameCode,
		  PlayerConsumeList.channelCode,
  		  PlayerConsumeList.itemCode,
		  PlayerConsumeList.consumeTime,
  		  PlayerConsumeList.amount,
		  GameVersion.id gv_id,
		  GameVersion.code gv_code,
		  GameVersion.version gv_version,
		  GameVersion.createTime gv_createTime,
		  GameVersion.summary gv_summary,
		  Game.id gv_game_id,
		  Game.name gv_game_name,
		  Game.createTime gv_game_createTime,
		  Game.summary gv_game_summary,
		  Channel.id c_id,
		  Channel.name c_name,
		  Channel.code c_code,
		  Channel.createTime c_createTime,
		  Channel.summary c_summary,
		  GameItem.name i_name,
		  GameItem.price i_price,
		  GameItem.createTime i_createTime,
		  GameItem.summary i_summary
		from
		  t_player_consume_list PlayerConsumeList,
		  t_game_version GameVersion,
		  t_game Game,
		  t_channel Channel,
		  t_game_item GameItem 
		<where>
			<trim suffix="and">
		 		<include refid="common.aliasPropertiesCondition" />
		 	</trim>
		 	PlayerConsumeList.channelCode = Channel.code
		   	and PlayerConsumeList.gameCode = GameVersion.code
		   	and PlayerConsumeList.itemCode = GameItem.code
			and GameVersion.gameId = Game.id 
		</where>
		<include refid="common.sortCondition" />
		<include refid="common.pageCondition" />
	</select>
	
	<!-- 获取统计信息 -->
	<select id="listCount" resultType="java.util.Map">
		select 
		  PlayerConsumeList.channelCode,
		  PlayerConsumeList.gameCode,
		  Channel.name channelName,
		  Game.name gameName,
		  GameVersion.version gameVersion,
		  sum(PlayerConsumeList.amount) amountCount
		from
		<include refid="tableName" /> PlayerConsumeList
		<include refid="joinTable"/>
		<if test="!joinTableAlias.contains('GameVersion')">
     		join <include refid="com.markany.gameboss.game.pojo.GameVersion.tableName"/> GameVersion on GameVersion.code = <include refid="tableAlias" />.gameCode
     		join <include refid="com.markany.gameboss.game.pojo.Game.tableName"/> Game on Game.id = GameVersion.gameId
     	</if>
     	<if test="!joinTableAlias.contains('Channel')">
     		join <include refid="com.markany.gameboss.channel.pojo.Channel.tableName"/> Channel on Channel.code = <include refid="tableAlias" />.channelCode
     	</if>
		<trim prefix="where">
			<include refid="common.aliasPropertiesCondition" />
		</trim>
		group by channelCode, gameCode
		order by amountCount desc, channelCode asc, gameCode asc
	</select>
	
	<select id="count" resultType="java.lang.Integer">
     	select count(*) from 
     	<include refid="tableName" /> <include refid="tableAlias" />
     	<include refid="joinTable"/>
     	<trim prefix="where">
    		<include refid="common.aliasPropertiesCondition"/>
    	</trim>
     </select>

	<insert id="add" parameterType="PlayerConsumeList" useGeneratedKeys="true" keyColumn="id" keyProperty="id">
		insert into
		<include refid="tableName" />
		(
			 id
			,amount
			,consumeTime
			,gameCode
			,playerCode
			,channelCode
			,itemCode
		)
		values
		(
			 #{id}
			,#{amount}
			,#{consumeTime}
			,#{gameCode}
			,#{playerCode}
			,#{channelCode}
			,#{itemCode}
		)
	</insert>
	
	<update id="update" parameterType="PlayerConsumeList">
		update <include refid="tableName" /> 
		<trim prefix="set" suffixOverrides=",">
			<if test="amount != null">amount=#{amount},</if>
			<if test="consumeTime != null">consumeTime=#{consumeTime},</if>
			<if test="gameCode != null">gameCode=#{gameCode},</if>
			<if test="playerCode != null">playerCode=#{playerCode},</if>
			<if test="channelCode != null">channelCode=#{channelCode},</if>
			<if test="itemCode != null">itemCode=#{itemCode},</if>
		</trim>
		where id=#{id}
	</update>
</mapper>