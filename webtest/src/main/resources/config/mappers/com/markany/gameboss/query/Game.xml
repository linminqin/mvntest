<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="query.Game">
	
	<!-- 下载量查询 -->
	<select id="queryDownloadCount" resultType="java.util.HashMap">
		select l.stateDate, g.name gameName, v.version gameVersion, l.gameCode, c.name channelName, l.channelCode, sum(download) downloadCount 
		from t_player_activate_import l, t_channel c, t_game_version v, t_game g 
		where l.channelCode = c.code
		   	and l.gameCode = v.code
		   	and v.gameId = g.id
		<if test="_parameter.containsKey('channelCode') and channelCode != null and channelCode != ''">
			and l.channelCode = #{channelCode}
		</if>
		<if test="_parameter.containsKey('gameCode') and gameCode != null and gameCode != ''">
			and l.gameCode = #{gameCode}
		</if>
		<if test="_parameter.containsKey('beginDate') and beginDate != null and beginDate != ''">
			and l.stateDate >= #{beginDate}
		</if>
		<if test="_parameter.containsKey('endDate') and endDate != null and endDate != ''">
			<![CDATA[ and l.stateDate <= #{endDate}]]>
		</if>
		group by l.channelCode, l.gameCode, stateDate
  		order by stateDate desc, channelCode asc, gameCode asc
	</select>
	<!-- 下载量总计查询 -->
	<select id="queryDownloadCountTotal" resultType="java.util.HashMap">
		select sum(download) downloadCount 
		from t_player_activate_import l, t_channel c, t_game_version v, t_game g 
		where l.channelCode = c.code
		   	and l.gameCode = v.code
		   	and v.gameId = g.id
		<if test="_parameter.containsKey('channelCode') and channelCode != null and channelCode != ''">
			and l.channelCode = #{channelCode}
		</if>
		<if test="_parameter.containsKey('gameCode') and gameCode != null and gameCode != ''">
			and l.gameCode = #{gameCode}
		</if>
		<if test="_parameter.containsKey('beginDate') and beginDate != null and beginDate != ''">
			and l.stateDate >= #{beginDate}
		</if>
		<if test="_parameter.containsKey('endDate') and endDate != null and endDate != ''">
			<![CDATA[ and l.stateDate <= #{endDate}]]>
		</if>
	</select>
	
	<!-- 消费统计 -->
	<select id="queryConsumeCount" resultType="java.util.HashMap">
		select g.name gameName, v.version gameVersion, l.gameCode, c.name channelName, 
			l.channelCode, i.name itemName, l.itemCode, sum(l.amount) amountCount 
		from t_player_consume_list l, t_channel c, t_game_version v, t_game g, t_game_item i  
		where l.channelCode = c.code
		   	and l.gameCode = v.code
		   	and l.itemCode = i.code
		   	and v.gameId = g.id
		<if test="_parameter.containsKey('gameCode') and gameCode != null and gameCode != ''">
			and l.gameCode = #{gameCode}
		</if>
		<if test="_parameter.containsKey('channelCode') and channelCode != null and channelCode != ''">
			and l.channelCode = #{channelCode}
		</if>
		<if test="_parameter.containsKey('itemCode') and itemCode != null and itemCode != ''">
			and l.itemCode = #{itemCode}
		</if>
		<if test="_parameter.containsKey('beginTime') and beginTime != null">
			and l.consumeTime >= #{beginTime}
		</if>
		<if test="_parameter.containsKey('endTime') and endTime != null">
			<![CDATA[ and l.consumeTime <= #{endTime}]]>
		</if>
		group by gameCode, channelCode, itemCode
  		order by amountCount desc, channelCode, gameCode, itemCode
	</select>
	
	<!-- 在线用户数和在线时长查询 -->
	<select id="queryPlayerOnline" resultType="java.util.HashMap">
		select g.name gameName, v.version gameVersion, l.gameCode, c.name channelName, l.channelCode,
		  count(distinct playerCode) playerCount,
		  floor(sum(
		    unix_timestamp(
		      ifnull(
		        logoutTime,
		        date_add(loginTime, interval 2 hour)
		      )
		    ) - unix_timestamp(loginTime)
		  ) / count(distinct playerCode)/60) onlineTime
		from
		  t_player_online_list l, t_channel c, t_game_version v, t_game g 
		where l.channelCode = c.code 
		  and l.gameCode = v.code 
		  and v.gameId = g.id 
		  <if test="_parameter.containsKey('channelCode') and channelCode != null and channelCode != ''">
				and l.channelCode = #{channelCode}
		  </if>
		  <if test="_parameter.containsKey('gameCode') and gameCode != null and gameCode != ''">
				and l.gameCode = #{gameCode}
		  </if>
		  <if test="_parameter.containsKey('beginTime') and beginTime != null">
				and l.loginTime >= #{beginTime}
		  </if>
		  <if test="_parameter.containsKey('endTime') and endTime != null">
		  		<![CDATA[ and l.loginTime <= #{endTime}]]>
		  </if>
		group by channelCode, gameCode 
		order by playerCount desc, onlineTime desc, channelCode, gameCode
	</select>
</mapper>