<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.markany.gameboss.player.pojo.PlayerActivateList">
	<resultMap type="PlayerActivateList" id="basePlayerActivateList" extends="com.markany.gameboss.player.pojo.BasePlayerPojo.basePlayerPojo">
		<result column="gameCode" property="gameCode"/>
		<result column="channelCode" property="channelCode"/>
		<result column="activateTime" property="activateTime"/>
	</resultMap>
	<resultMap type="PlayerActivateList" id="playerActivateList" extends="com.markany.gameboss.player.pojo.PlayerActivateList.basePlayerActivateList">
		<association column="playerCode" property="player" select="com.markany.gameboss.player.pojo.Player.findByCode"/>
		<association column="channelCode" property="channel" select="com.markany.gameboss.channel.pojo.Channel.findByCode"/>
		<association column="gameCode" property="gameVersion" select="com.markany.gameboss.game.pojo.GameVersion.findByCode"/>
	</resultMap>
	<resultMap type="PlayerActivateList" id="playerActivateListDetail" extends="com.markany.gameboss.player.pojo.PlayerActivateList.basePlayerActivateList">
		<association property="gameVersion" column="id" foreignColumn="gameversionId" resultMap="com.markany.gameboss.game.pojo.GameVersion.gameVersionDetail"  columnPrefix="gv_"/>
		<association property="channel" column="id" foreignColumn="channelId" resultMap="com.markany.gameboss.channel.pojo.Channel.channel"  columnPrefix="c_"/>
	</resultMap>
	<resultMap type="PlayerActivateListExtend" id="playerActivateListDetailExtend" extends="com.markany.gameboss.player.pojo.BasePlayerPojo.basePlayerPojo">
		<result column="gameName" property="gameName"/>
		<result column="gameversion" property="gameversion"/>
		<result column="channelName" property="channelName"/>
		<result column="playerOperatorName" property="playerOperatorName"/>
		<result column="playerCityName" property="playerCityName"/>
		<result column="playerLastActiveTime" property="playerLastActiveTime"/>
		<result column="playerProvinceName" property="playerProvinceName"/>
		<result column="playerImsi" property="playerImsi"/>
	</resultMap>
	
	<sql id="tableName">
		t_player_activate_list
	</sql>
	<sql id="tableAlias">
		PlayerActivateList
	</sql>
	<sql id="joinTable">
		<if test="hasJoin and joinTableAlias.contains('GameVersion')">
     		join <include refid="com.markany.gameboss.game.pojo.GameVersion.tableName"/> GameVersion on GameVersion.code = <include refid="tableAlias" />.gameCode
     		join <include refid="com.markany.gameboss.game.pojo.Game.tableName"/> Game on Game.id = GameVersion.gameId
     	</if>
     	<if test="hasJoin and joinTableAlias.contains('Channel')">
     		join <include refid="com.markany.gameboss.channel.pojo.Channel.tableName"/> Channel on Channel.code = <include refid="tableAlias" />.channelCode
     	</if>
     	<if test="joinTableAlias.contains('Province') or (hasJoin and joinTableAlias.contains('Player'))">
     		join <include refid="com.markany.gameboss.player.pojo.Player.tableName"/> Player on Player.code = <include refid="tableAlias" />.playerCode
     			<if test="joinTableAlias.contains('Province')">
     				join <include refid="com.lmiky.area.pojo.City.tableName"/> City on City.code = Player.region
     				join <include refid="com.lmiky.area.pojo.Province.tableName"/> Province on Province.id = City.province
     			</if>
     	</if>
	</sql>

	<select id="find" resultMap="playerActivateList">
		select * from 
		<include refid="tableName"/> <include refid="tableAlias" />
		<include refid="joinTable"/>
		<trim prefix="where">
			<include refid="common.aliasPropertiesCondition"/>
		</trim>
	</select>
	
	<select id="findById" resultMap="playerActivateList">
		select * from 
		<include refid="tableName"/>
		where id = #{id}
	</select>
	
	<select id="list" resultMap="playerActivateList">
		select * from
		<include refid="tableName" /> <include refid="tableAlias" />
		<include refid="joinTable"/>
		<trim prefix="where">
			<include refid="common.aliasPropertiesCondition" />
		</trim>
		<include refid="common.sortCondition" />
		<include refid="common.pageCondition" />
	</select>
	
	<!-- 列出详细信息 -->
	<select id="listDetail" resultMap="playerActivateListDetail">
		select 
		  PlayerActivateList.id,
		  PlayerActivateList.playerCode,
		  PlayerActivateList.gameCode,
		  PlayerActivateList.channelCode,
		  PlayerActivateList.activateTime,
		  GameVersion.id gv_id,
		  GameVersion.code gv_code,
		  GameVersion.version gv_version,
		  GameVersion.createTime gv_createTime,
		  GameVersion.summary gv_summary,
		  Game.id gv_game_id,
		  Game.name gv_game_name,
		  Game.createTime gv_game_createTime,
		  Game.summary gv_game_summary,
		  Channel.id c_id,
		  Channel.name c_name,
		  Channel.code c_code,
		  Channel.createTime c_createTime,
		  Channel.summary c_summary
		from
		  t_player_activate_list PlayerActivateList,
		  t_game_version GameVersion,
		  t_game Game,
		  t_channel Channel 
		<where>
			<trim suffix="and">
		 		<include refid="common.aliasPropertiesCondition" />
		 	</trim>
		 	PlayerActivateList.channelCode = Channel.code
		   	and PlayerActivateList.gameCode = GameVersion.code
			and GameVersion.gameId = Game.id 
		</where>
		<include refid="common.sortCondition" />
		<include refid="common.pageCondition" />
	</select>
	
	<!-- 列出详细信息 -->
	<select id="listDetailExtend" resultMap="playerActivateListDetailExtend">
		select 
		  PlayerActivateList.id,
		  PlayerActivateList.playerCode,
		  PlayerActivateList.gameCode,
		  PlayerActivateList.channelCode,
		  PlayerActivateList.activateTime,
		  GameVersion.version gameversion,
		  Game.name gameName,
		  Channel.name channelName,
		  Player.operator playerOperatorName, 
		  Player.lastActiveTime playerLastActiveTime,
		  City.name playerCityName, 
		  Province.name playerProvinceName,
		  Player.imsi playerImsi
		from
		  t_player_activate_list PlayerActivateList,
		  t_game_version GameVersion,
		  t_game Game,
		  t_channel Channel,
		  t_player Player,
		  t_city City,
		  t_province Province  
		<where>
			<trim suffix="and">
		 		<include refid="common.aliasPropertiesCondition" />
		 	</trim>
		 	PlayerActivateList.channelCode = Channel.code
		   	and PlayerActivateList.gameCode = GameVersion.code
			and GameVersion.gameId = Game.id 
			and PlayerActivateList.playerCode = Player.code
			and Player.region = City.code
			and City.province = Province.id
		</where>
		<include refid="common.sortCondition" />
		<include refid="common.pageCondition" />
	</select>
	
	<!-- 获取统计信息 -->
	<select id="listCount" resultType="java.util.Map">
		select 
		  PlayerActivateList.channelCode,
		  PlayerActivateList.gameCode,
		  Channel.name channelName,
		  Game.name gameName,
		  GameVersion.version gameVersion,
		  count(*) downloadCount
		from
		<include refid="tableName" /> PlayerActivateList
		<include refid="joinTable"/>
		<if test="!joinTableAlias.contains('GameVersion')">
     		join <include refid="com.markany.gameboss.game.pojo.GameVersion.tableName"/> GameVersion on GameVersion.code = <include refid="tableAlias" />.gameCode
     		join <include refid="com.markany.gameboss.game.pojo.Game.tableName"/> Game on Game.id = GameVersion.gameId
     	</if>
     	<if test="!joinTableAlias.contains('Channel')">
     		join <include refid="com.markany.gameboss.channel.pojo.Channel.tableName"/> Channel on Channel.code = <include refid="tableAlias" />.channelCode
     	</if>
		<trim prefix="where">
			<include refid="common.aliasPropertiesCondition" />
		</trim>
		group by channelCode, gameCode
		order by downloadCount desc, channelCode asc, gameCode asc
	</select>
	
	<select id="count" resultType="java.lang.Integer">
     	select count(*) from 
     	<include refid="tableName" /> <include refid="tableAlias" />
     	<include refid="joinTable"/>
     	<trim prefix="where">
    		<include refid="common.aliasPropertiesCondition"/>
    	</trim>
     </select>

	<insert id="add" parameterType="PlayerActivateList" useGeneratedKeys="true" keyColumn="id" keyProperty="id">
		insert into
		<include refid="tableName" />
		(
			 id
			,activateTime
			,gameCode
			,channelCode
			,playerCode
		)
		values
		(
			 #{id}
			,#{activateTime}
			,#{gameCode}
			,#{channelCode}
			,#{playerCode}
		)
	</insert>
	
	<update id="update" parameterType="PlayerActivateList">
		update <include refid="tableName" /> 
		<trim prefix="set" suffixOverrides=",">
			<if test="activateTime != null">activateTime=#{activateTime},</if>
			<if test="gameCode != null">gameCode=#{gameCode},</if>
			<if test="playerCode != null">playerCode=#{playerCode},</if>
			<if test="channelCode != null">channelCode=#{channelCode},</if>
		</trim>
		where id=#{id}
	</update>
</mapper>